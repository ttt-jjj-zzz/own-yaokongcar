# yaokong_faster_car_baby 项目说明

## 项目用途
本项目用于在鲁班猫 LubanCat3 上控制阿克曼小车：
- 后轮双电机（左/右）通过 L298N 驱动实现前进/后退。
- 前部转向舵机负责左右转向。
- 车载摄像头舵机（第二舵机）用于控制摄像头转动（当前代码主要实现转向舵机，摄像头舵机可按需求扩展）。
- 遥控信号使用 SBUS 接收，主控通过串口读取。
- 同时提供低带宽 MJPEG 摄像头视频流。

## 硬件与接口概述
- 主控板：LubanCat3
- 电机驱动：L298N（控制后轮左/右电机）
- 舵机：2 个（转向舵机 + 摄像头舵机）
- 遥控接收：SBUS（串口 /dev/ttyS3）
- 摄像头：V4L2 设备 /dev/video0（自动回退 /dev/video1）

## 当前已启用 PWM 资源与 Chip 映射
- **pwm0** (sysfs: pwmchip0) -> `PWM1_CH0_M3` (Pin 33): 左电机
- **pwm1** (sysfs: pwmchip1) -> `PWM1_CH1_M1` (Pin 19): 摄像头舵机 (新增)
- **pwm2** (sysfs: pwmchip2) -> `PWM2_CH3_M3` (Pin 35): 右电机
- **pwm3** (sysfs: pwmchip3) -> `PWM2_CH6_M3` (Pin 12): 风扇 (系统占用, 未使用)
- **pwm4** (sysfs: pwmchip4) -> `PWM2_CH7_M3` (Pin 32): 转向舵机

## 舵机中位微调功能 (新增)
为解决小车长期运行后机械结构偏差导致跑偏的问题，新增“遥控器在线微调”功能。修改后的中位值将**永久保存**，重启不失效。

### 1. 操作逻辑
- **正常模式**：
  - `CH6` 或 `CH7`（开关通道）处于 **低位**（例如 < 1500，默认状态）。
  - 小车使用当前保存的中位值运行。

- **校准模式**：
  - 将 `CH6` 或 `CH7` 拨到 **高位**（例如 > 1500）。
  - 此时 `CH8`（旋钮或滑杆）接管舵机控制：
    - `CH8` 中位（~1500）对应舵机脉宽 1500us。
    - 转动 `CH8` 可直接驱动前轮左右微调。
  - **动态微调**（更新）：
    - 你可以**推油门 (CH1)** 让小车直线行驶。
    - 在行驶中观察车身是否跑偏，同时拧动 `CH8` 直到小车能走出完美的直线。
    - **注意**：校准模式下方向摇杆 (CH3) 暂时失效，只有油门有效。

- **保存退出**：
  - 保持 `CH8` 不动（保持回正位置），将 `CH6/7` 拨回 **低位**。
  - 系统自动记录当前 `CH8` 的对应的脉宽值作为新的 `SERVO_MID_US`。
  - 自动计算并更新左右极限：`MIN = MID - 150`, `MAX = MID + 150`。
  - 数值写入 `servo_config.json`，永久生效。

### 2. 通道需求
- **CH6 或 CH7**: 2段或3段开关（用于触发校准模式）。
- **CH8**: 旋钮或滑杆（用于精细调节角度）。

## 主要功能流程
1. 启动后：
   - 读取 `servo_config.json` 加载舵机中位校准值（若无则使用默认值）。
   - 初始化 PWM、GPIO、舵机、电机。
2. SBUS 循环：
   - CH3：转向（阿克曼转向）
   - CH1：油门（前进/后退）
   - CH9：摄像头云台（左右旋转）
3. 将 SBUS 值映射为 -1.0~1.0 控制值：
   - `Servo.set_angle()` 控制转向舵机角度
   - `cam_servo.set_angle()` 控制摄像头舵机角度
   - `Motor.set_speed()` 同步控制左右后轮电机
4. 摄像头开启低带宽 MJPEG 流，便于低延迟遥控观测。

## 目录与文件说明
- main.py
  - 项目主程序：初始化硬件、读取 SBUS、执行转向与驱动控制、启动摄像头流。
- motor.py
  - 电机驱动封装：基于 PWM + GPIO 控制方向与速度。
- servo.py
  - 舵机控制封装：基于 PWM 输出，含中位与行程校准。
- pwm.py
  - PWM sysfs 操作封装。
- sbus_receiver.py
  - SBUS 协议解析：读取 16 通道数据并进行连接状态判断。
- camera_stream.py
  - 低带宽 MJPEG 视频流服务，适合无线遥控场景。
- install_autostart.sh
  - systemd 自启动脚本，一键设置开机运行主程序。

## 依赖说明
- Python 3
- pyserial（SBUS 串口）
- opencv-python（摄像头视频流）

## 运行方式
- 直接运行：
  - `python3 main.py`
- 设置开机自启：
  - `sudo bash install_autostart.sh`

## SBUS 说明
- 端口：/dev/ttyS3
- 需要在 /boot/uEnv/uEnv.txt 中启用对应 overlay
- 通道映射详细说明：
  - **CH1** (Elevator/纵向摇杆): 控制 **左右后轮电机** (前进/后退)
  - **CH3** (Rudder/方向摇杆): 控制 **前轮转向舵机** (左转/右转)
  - **CH9** (Aux/辅助开关或旋钮): 控制 **摄像头云台舵机** (左看/右看)

## 注意事项
- PWM/GPIO 通过 sysfs 访问，需 root 权限或合适的权限配置。
- 舵机校准参数在 servo.py 中（中位、左右极限）。
- 若遥控信号丢失，会自动停止电机并回中舵机。
- 摄像头流地址：`http://<IP>:8080/`

